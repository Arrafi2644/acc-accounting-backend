import httpStatus from 'http-status-codes';
import AppError from "../../errorHelpers/appError";
import { IService} from "./service.interface";
import { Service} from "./service.model";
import { QueryBuilder } from '../../utils/queryBuilder';
import { ServicesSearchableFields } from './service.constants';


// Service 
const createService = async (payload: IService) => {
    const existingService = await Service.findOne({ title: payload.title });
    if (existingService) {
        throw new Error("A service with this title already exists.");
    }

    const service = await Service.create(payload)

    return service;
};

const getSingleService = async (serviceSlug: string) => {

    const service = await Service.findOne({slug: serviceSlug})

    if (!service) {
        throw new AppError(httpStatus.NOT_FOUND, "Service not found")
    }

    return service;
};

const updateService = async (id: string, payload: Partial<IService>) => {

    const updatedService = await Service.findByIdAndUpdate(
        id,
        payload,
        { new: true, runValidators: true }
    );
    
    if (!updatedService) {
        throw new AppError(404, "Service not found");
    }

    return updatedService;
}
const getAllServices = async (query: Record<string, string>) => {

    const queryBuilder = new QueryBuilder(Service.find(), query)

    const services = await queryBuilder
        .search(ServicesSearchableFields)
        .filter()
        .sort()
        .fields()
        .paginate()

    const [data, meta] = await Promise.all([
        services.build(),
        queryBuilder.getMeta()
    ])

    return {
        data,
        meta
    }
};

const deleteService = async (serviceId: string) => {
    const service = await Service.findById(serviceId);

    if (!service) {
        throw new AppError(httpStatus.NOT_FOUND, "Service not found");
    }

    await service.deleteOne();

    return null;
};

export const ServiceServices = {
    createService,
    getSingleService,
    updateService,
    getAllServices,
    deleteService
}